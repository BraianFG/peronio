<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PERONIO × World ID</title>
  <script src="https://developer.worldcoin.org/world-id.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Clear+Sans:wght@700&display=swap');
    body {margin:0;height:100vh;background:#121213;color:white;font-family:'Clear Sans',sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;}
    h1 {font-size:3rem;margin-bottom:1rem;color:#538d4e;}
    .grid {display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:30px 0;}
    .tile {width:56px;height:56px;background:#3a3a3c;border:2px solid #565758;display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:bold;text-transform:uppercase;}
    .green {background:#538d4e !important;border-color:#538d4e !important;color:white;animation:pop .2s;}
    button {padding:16px 40px;font-size:1.5rem;font-weight:bold;background:#538d4e;color:white;border:none;border-radius:8px;cursor:pointer;transition:.2s;margin:10px;}
    button:hover:not(:disabled){background:#6aaa64;}
    button:disabled{background:#3a3a3c;cursor:not-allowed;opacity:0.7;}
    .message{margin:20px 0;font-size:1.4rem;}
    .balance{margin-top:10px;font-size:1.3rem;color:#b9cfba;}
    @keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
  </style>
</head>
<body>
  <h1>PERONIO</h1>
  
  <div class="grid">
    <div class="tile">P</div><div class="tile">E</div><div class="tile">R</div>
    <div class="tile">O</div><div class="tile">N</div><div class="tile">I</div>
    <div class="tile">O</div>
  </div>

  <button id="verifyBtn">Verificar con World ID</button>
  <button id="claimBtn" disabled>¡Reclama 100 PERONIOS!</button>

  <div class="message" id="message"></div>
  <div class="balance">Tus PERONIOS: <strong id="totalTokens">0</strong></div>

  <script>
    const verifyBtn = document.getElementById("verifyBtn");
    const claimBtn = document.getElementById("claimBtn");
    const message = document.getElementById("message");
    const totalTokens = document.getElementById("totalTokens");
    const tiles = document.querySelectorAll(".tile");

    const KEY_VERIFIED = "peronio_worldid_verified";   // 24h de validez
    const KEY_CLAIM    = "peronio_last_claim";
    const KEY_BALANCE  = "peronio_balance";

    let balance = parseInt(localStorage.getItem(KEY_BALANCE)) || 0;
    totalTokens.textContent = balance;

    // Verificar si ya está verificado y no pasó 24h
    function isVerifiedToday() {
      const verified = localStorage.getItem(KEY_VERIFIED);
      if (!verified) return false;
      const diff = Date.now() - parseInt(verified);
      return diff < 24 * 60 * 60 * 1000;
    }

    function canClaimToday() {
      const last = localStorage.getItem(KEY_CLAIM);
      if (!last) return true;
      const diff = Date.now() - parseInt(last);
      return diff >= 24 * 60 * 60 * 1000;
    }

    function updateUI() {
      if (isVerifiedToday()) {
        verifyBtn.textContent = "Verificado hoy";
        verifyBtn.disabled = true;
        verifyBtn.style.background = "#3a3a3c";

        if (canClaimToday()) {
          claimBtn.disabled = false;
          claimBtn.textContent = "¡Reclama 100 PERONIOS!";
          message.textContent = "¡Listo! Puedes reclamar tus 100 PERONIOS diarios";
        } else {
          const next = new Date(parseInt(localStorage.getItem(KEY_CLAIM)) + 24*60*60*1000);
          message.textContent = `Ya reclamaste hoy · Vuelve a las ${next.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
          claimBtn.disabled = true;
          claimBtn.textContent = "Ya reclamaste hoy";
          tiles.forEach(t => t.classList.add("green"));
        }
      }
    }

    // Botón de verificación con World ID
    verifyBtn.onclick = async () => {
      try {
        const result = await WorldID.verify({
          action: "peronio-daily-claim",
          signal: "",
        });

        if (result.success) {
          localStorage.setItem(KEY_VERIFIED, Date.now().toString());
          message.textContent = "¡Verificación exitosa! Eres humano";
          updateUI();
        }
      } catch (err) {
        message.textContent = "Verificación cancelada o fallida";
      }
    };

    // Reclamo
    claimBtn.onclick = () => {
      if (!isVerifiedToday() || !canClaimToday()) return;

      tiles.forEach((tile, i) => {
        setTimeout(() => tile.classList.add("green"), i * 130);
      });

      balance += 100;
      localStorage.setItem(KEY_BALANCE, balance);
      localStorage.setItem(KEY_CLAIM, Date.now().toString());
      totalTokens.textContent = balance;

      message.textContent = "¡+100 PERONIOS reclamados! Vuelve mañana";
      updateUI();
    };

    // Cargar estado al abrir
    updateUI();
  </script>
</body>
</html>
